name: GenAI Research Assistant CD to Hugging Face

on:
  workflow_run:
    workflows: ["GenAI Research Assistant CI"]
    branches: [main, master]
    types:
      - completed
  # Optional: Enable manual deployment
  workflow_dispatch:

jobs:
  deploy-to-huggingface:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Hugging Face
        run: |
          pip install huggingface_hub
          # Create HF credentials file directly
          mkdir -p ~/.huggingface
          echo "{ \"api_key\": \"${{ secrets.HF_TOKEN }}\" }" > ~/.huggingface/token
      
      - name: Clone Hugging Face Space
        env:
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # Clone the Hugging Face Space repo (or create it if it doesn't exist)
          if ! git clone https://huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME repo; then
            mkdir -p repo
            cd repo
            git init
            git remote add origin https://huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME
            cd ..
          fi
      
      - name: Create HF Space Configuration Files
        run: |
          # Copy docker/huggingface-space.yaml as README.md
          cp docker/huggingface-space.yaml repo/README.md
          
          # Create custom entrypoint script for Hugging Face Spaces
          cat > repo/hf-entrypoint.sh << EOL
          #!/bin/bash
          set -e

          # Create supervisord configuration in a writable directory
          mkdir -p /tmp/supervisor
          
          # Create a modified supervisord.conf for HF Spaces
          cat > /tmp/supervisor/supervisord.conf << EOSUPERVISOR
          [supervisord]
          nodaemon=true
          logfile=/tmp/supervisord.log
          logfile_maxbytes=50MB
          loglevel=info

          [program:backend]
          command=uvicorn app.main:app --host 0.0.0.0 --port 7860
          directory=/app
          autostart=true
          autorestart=true
          stdout_logfile=/dev/stdout
          stdout_logfile_maxbytes=0
          stderr_logfile=/dev/stderr
          stderr_logfile_maxbytes=0
          environment=PYTHONUNBUFFERED=1

          [program:frontend]
          command=serve -s frontend/build -l 3000
          directory=/app
          autostart=true
          autorestart=true
          stdout_logfile=/dev/stdout
          stdout_logfile_maxbytes=0
          stderr_logfile=/dev/stderr
          stderr_logfile_maxbytes=0
          EOSUPERVISOR
          
          echo "Starting supervisord with configuration in /tmp/supervisor"
          exec /usr/bin/supervisord -c /tmp/supervisor/supervisord.conf
          EOL
          
          # Make the entrypoint script executable
          chmod +x repo/hf-entrypoint.sh
          
          # Create Dockerfile that pulls from DockerHub and uses our custom entrypoint
          cat > repo/Dockerfile << EOL
          FROM ${{ secrets.DOCKERHUB_USERNAME }}/genai-research-assistant:latest
          
          # Copy the HF-specific entrypoint script
          COPY hf-entrypoint.sh /hf-entrypoint.sh
          
          # Expose the port Hugging Face will use
          EXPOSE 7860
          
          # Use our HF-specific entrypoint
          ENTRYPOINT ["/hf-entrypoint.sh"]
          EOL
      
      - name: Push to Hugging Face Space
        env:
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          # Create Docker configuration for Hugging Face
          mkdir -p repo/.docker
          
          # Create .gitattributes for LFS
          echo "*.bin filter=lfs diff=lfs merge=lfs -text" > repo/.gitattributes
          
          # Commit and push changes
          cd repo
          git add .
          git commit -m "Update Space with latest GenAI Research Assistant"
          git push -f https://${{ secrets.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME main
      
      - name: Wait for deployment and post status
        env:
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          echo "Deploying to Hugging Face Space: https://huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME"
          echo "Deployment triggered! It may take a few minutes to complete."
          echo "IMPORTANT: Remember to set the following environment variables in your Hugging Face Space settings:"
          echo "- DATABASE_URL (if using external database)"
          echo "- OPENAI_API_KEY"
          echo "- GOOGLE_API_KEY"
          echo "- META_API_KEY" 